<!doctype html>
<html lang="en-GB">
<head>
    <meta charset="utf-8">

    <style>
      .root {
        width: fit-content;
      }

      [role=combobox] {
        padding: 1em;
        border: 3px solid #c3c3c9;
        border-radius: 0.25em;
      }

      .listbox {
        height: 0;
        overflow-y: hidden;
      }

      [aria-expanded=true] ~ .listbox {
        height: auto;
        overflow-y: visible;
        border: 3px solid #c3c3c9;
        border-radius: 0.25em;
      }

      [role=option] {
        padding: 1em;
      }

      [role=option]:hover {
        background-color: rgb(0 0 0 / 10%);
      }

      [role=option].current {
        outline: 3px solid #0067b8;
        outline-offset: -3px;
      }
    </style>
</head>
<body>
<form>
    <label id="combo-label">Choose a choice</label>
    <div class="root">
        <div aria-controls="listbox"
             aria-expanded="false"
             aria-haspopup="listbox"
             aria-labelledby="combo-label"
             id="combo"
             role="combobox"
             tabindex="0"
        >
            First choice
        </div>
        <div class="listbox"
             role="listbox"
             id="listbox"
             aria-labelledby="combo-label"
             tabindex="-1"
        >
            <div role="option" id="option-0" class="current" aria-selected="true">First choice</div>
            <div role="option" id="option-1" aria-selected="false">Second choice</div>
            <div role="option" id="option-2" aria-selected="false">Third choice</div>
            <div role="option" id="option-3" aria-selected="false">Fourth choice</div>
            <div role="option" id="option-4" aria-selected="false">Fifth choice</div>
            <div role="option" id="option-5" aria-selected="false">Sixth choice</div>
            <div role="option" id="option-6" aria-selected="false">Seventh choice</div>
            <div role="option" id="option-7" aria-selected="false">Eighth choice</div>
            <div role="option" id="option-8" aria-selected="false">Ninth choice</div>
            <div role="option" id="option-9" aria-selected="false">Tenth choice</div>
            <div role="option" id="option-10" aria-selected="false">Eleventh choice</div>
            <div role="option" id="option-11" aria-selected="false">Twelfth choice</div>
            <div role="option" id="option-12" aria-selected="false">Thirteenth choice</div>
        </div>
    </div>
</form>

<script>
  const Actions = {
    Open: 0,
    Close: 1,
    Up: 2,
    Down: 3,
    PageUp: 4,
    PageDown: 5,
    First: 7,
    Last: 8,
    Select: 9,
    SelectAndClose: 10,
  };

  class Select {
    constructor(el) {
      this.el = el;
      this.combobox = el.querySelector('[role=combobox]');
      this.listbox = el.querySelector('[role=listbox]');

      this.activeIndex = 0;
      this.open = false;

      for (let index = 0; index < this.listbox.children.length; index++) {
        this.listbox.children[index].addEventListener('click', (event) => {
          event.stopPropagation();
          this.activeIndex = index;
          this.select();
          this.click(event);
        });
        this.listbox.children[index].addEventListener('mousedown', () => {
          this.ignoreBlur = true;
        });
      };

      this.options = [...this.listbox.children].map((option) => {
        return option.textContent;
      });

      this.combobox.addEventListener('click', this.click.bind(this));
      this.combobox.addEventListener('blur', this.blur.bind(this));
      this.combobox.addEventListener('keydown', this.keydown.bind(this));
    }

    blur(event) {
      if (this.ignoreBlur) {
        this.ignoreBlue = false;
        return;
      }

      if (this.open) {
        this.select();
        this.closeList();
      }
    }

    click(event) {
      this.open ? this.closeList() : this.openList();
    }

    keydown(event) {
      const action = this.actionFromKey(event);

      switch (action) {
        case Actions.Last:
        case Actions.First:
          this.openList();
          // intentional fallthrough
        case Actions.Up:
        case Actions.Down:
        case Actions.PageUp:
        case Actions.PageDown:
          event.preventDefault();
          this.updateActiveIndex(action);
          this.refresh();
          break;
        case Actions.SelectAndClose:
          event.preventDefault();
          this.select();
          // intentional fallthrough
        case Actions.Close:
          event.preventDefault();
          this.closeList();
          return;
        case Actions.Open:
          event.preventDefault();
          return this.openList();
      }
    }

    actionFromKey(event) {
      const {key, altKey, ctrlKey, metaKey} = event;
      const openKeys = ['ArrowDown', 'ArrowUp', 'Enter', ' ']; // all keys that will do the default open action
      // handle opening when closed
      if (!this.open && openKeys.includes(key)) {
        return Actions.Open;
      }

      // home and end move the selected option when open or closed
      if (key === 'Home') {
        return Actions.First;
      }
      if (key === 'End') {
        return Actions.Last;
      }

      // handle keys when open
      if (this.open) {
        if (key === 'ArrowUp' && altKey) {
          return Actions.SelectAndClose;
        } else if (key === 'ArrowDown' && !altKey) {
          return Actions.Down;
        } else if (key === 'ArrowUp') {
          return Actions.Up;
        } else if (key === 'PageUp') {
          return Actions.PageUp;
        } else if (key === 'PageDown') {
          return Actions.PageDown;
        } else if (key === 'Escape') {
          return Actions.Close;
        } else if (key === 'Enter' || key === ' ') {
          return Actions.SelectAndClose;
        }
      }
    }

    updateActiveIndex(action) {
      const max = this.options.length - 1;

      switch (action) {
        case Actions.Up:
          this.activeIndex -= 1;
          break;
        case Actions.Down:
          this.activeIndex += 1;
          break;
        case Actions.PageUp:
          this.activeIndex -= 10;
          break;
        case Actions.PageDown:
          this.activeIndex += 10;
          break;
        case Actions.First:
          this.activeIndex = 0;
          break;
        case Actions.Last:
          this.activeIndex = max;
          break;
      }

      if (this.activeIndex > max) {
        this.activeIndex = max;
      }
      if (this.activeIndex < 0) {
        this.activeIndex = 0;
      }
    }

    refresh() {
      this.combobox.setAttribute('aria-activedescendant', `option-${this.activeIndex}`);

      const options = this.el.querySelectorAll('[role=option]');
      [...options].forEach((option) => {
        option.classList.remove('current');
      });
      options[this.activeIndex].classList.add('current');
    }

    select() {
      this.combobox.innerHTML = this.options[this.activeIndex];

      const options = this.el.querySelectorAll('[role=option]');
      [...options].forEach((option) => {
        option.setAttribute('aria-selected', 'false');
      });
      options[this.activeIndex].setAttribute('aria-selected', 'true');
    }

    openList() {
      if (!this.open) {
        this.open = true;
        this.combobox.setAttribute('aria-expanded', 'true');

        this.refresh();

        this.combobox.focus();
      }
    }

    closeList() {
      this.open = false;
      this.combobox.setAttribute('aria-expanded', 'false');
      this.el.setAttribute('aria-activedescendant', '');

      this.combobox.focus();
    }
  }

  new Select(document.querySelector('.root'));

  document.addEventListener('keydown', (event) => {
    console.log('focus', document.activeElement);
  });

  document.addEventListener('click', (event) =>{
    console.log('click', event.path);
  });
</script>
</body>